# This workflow will install Python dependencies, run tests and lint with multiple versions of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.12"]
    
    env:
      LHP_DISABLE_ANALYTICS: 1

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest pytest-cov black
        # Install the package in development mode
        pip install -e .
        # Install additional requirements if they exist
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      shell: bash
        
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics 
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics 
      shell: bash
          
    - name: Test with pytest
      run: |
        # Run tests with coverage if tests directory exists
        if [ -d "tests" ]; then
          # Run unit tests sequentially (fast anyway)
          pytest tests/ --ignore=tests/e2e --cov --cov-branch --junitxml=junit-unit.xml -o junit_family=legacy
          # Run e2e tests in parallel with auto-detected CPU count
          pytest tests/e2e -n auto --cov --cov-append --cov-branch --cov-report=xml --cov-fail-under=40 --junitxml=junit-e2e.xml -o junit_family=legacy
        else
          echo "No tests directory found, skipping tests"
        fi
      shell: bash

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        slug: Mmodarre/Lakehouse_Plumber
    
    - name: Upload test results to Codecov
      if: ${{ !cancelled() }}
      uses: codecov/test-results-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

  # Windows-specific e2e tests using native PowerShell
  test-e2e-windows:
    runs-on: windows-latest
    
    env:
      LHP_DISABLE_ANALYTICS: 1

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-3.12-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-3.12-
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest pytest-cov pytest-xdist black
        pip install -e .
        if (Test-Path requirements.txt) { pip install -r requirements.txt }
        if (Test-Path requirements-dev.txt) { pip install -r requirements-dev.txt }
        
    - name: Test with pytest (e2e only)
      run: |
        if (Test-Path tests\e2e) {
          pytest tests\e2e -n auto --cov --cov-branch --cov-report=xml --junitxml=junit-e2e-windows.xml -o junit_family=legacy
        } else {
          Write-Host "No e2e tests directory found, skipping tests"
        }

  # Separate job for testing import functionality across platforms
  test-import:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    
    env:
      LHP_DISABLE_ANALYTICS: 1
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install package
      run: |
        python -m pip install --upgrade pip
        pip install -e .
      shell: bash
    
    - name: Test basic import and CLI
      run: |
        # Test that the package can be imported without syntax errors
        python -c "import lhp; print('[OK] Package imports successfully')"
        # Test that the CLI command works
        lhp --version || echo "CLI version check failed"
        lhp --help > /dev/null && echo "[OK] CLI help works" || echo "CLI help failed"
      shell: bash